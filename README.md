# n8n on AWS

Production-ready [n8n](https://n8n.io/) deployment on AWS EC2 using Podman. Runs a complete workflow automation platform with AI document processing, external task runners, and persistent storage on a single t3.xlarge instance.

## Architecture

Five containerized services orchestrated via `docker-compose.yml` on a Podman runtime:

| Service | Image | Purpose |
|---------|-------|---------|
| **n8n** | `docker.n8n.io/n8nio/n8n:stable` | Workflow automation engine |
| **PostgreSQL** | `postgres:latest` | Workflow database (definitions, credentials, execution history) |
| **Redis** | `redis:latest` | AI chat memory + queue broker |
| **Task Runners** | Custom (JS + Python) | External code execution with pandas, numpy, requests |
| **Docling Serve** | `docling-serve-cpu:latest` | Document conversion REST API (PDF to Markdown/JSON) |

### Resource Allocation (16 GB)

| Component | Memory | CPU |
|-----------|--------|-----|
| PostgreSQL | 4 GB | 1.5 |
| n8n | 6 GB | 1.5 |
| Task Runners | 3 GB | 1.0 |
| Redis | 512 MB | 0.25 |
| Docling Serve | uncapped* | uncapped* |
| OS overhead | ~1.5 GB | -- |

\* Enable limits after observing real-world usage with `podman stats`.

## Prerequisites

- **AWS EC2 t3.xlarge** (4 vCPU, 16 GB RAM) or equivalent
- **Linux** with cgroups v2 enabled
- **Podman** + **podman-compose** (not Docker)
- 50+ GB disk space

```bash
# Verify cgroups v2
mount | grep cgroup2

# Install Podman (RHEL/CentOS)
sudo dnf install podman podman-compose

# Install Podman (Debian/Ubuntu)
sudo apt install podman
pip3 install podman-compose
```

## Quick Start

```bash
# 1. Clone the repository
git clone https://github.com/khamsakamal48/n8n-on-AWS.git
cd n8n-on-AWS

# 2. Copy files to your server
scp -r . ec2-user@your-server:/tmp/n8n-production/

# 3. SSH in and deploy
ssh ec2-user@your-server
cd /tmp/n8n-production
chmod +x deploy.sh
./deploy.sh

# 4. Download Docling VLM models (wait ~2 min for Docling to boot first)
cd /opt/n8n-production
./docling/download-models.sh
```

`deploy.sh` handles everything automatically:
- Generates cryptographic secrets for the database, Redis, n8n encryption key, and runner auth tokens
- Creates the directory structure at `/opt/n8n-production`
- Installs a systemd timer for daily image update checks
- Starts services in the correct order (PostgreSQL + Redis, then n8n, then runners + Docling)
- Verifies health of all services

## Project Structure

```
.
├── docker-compose.yml              # Service orchestration (5 containers)
├── .env                            # Secrets (auto-generated by deploy.sh)
├── deploy.sh                       # One-command deployment script
├── check-updates.sh                # Podman-native image update checker
├── postgres/
│   ├── postgresql.conf             # Production tuning (PGTune)
│   ├── init/
│   │   └── 01-init-n8n.sql         # First-boot schema setup
│   └── data/                       # Database persistence
├── redis/
│   ├── redis.conf                  # 256 MB maxmemory, AOF + RDB
│   └── data/                       # Redis persistence
├── n8n/
│   └── data/                       # n8n config & execution data
├── runners/
│   ├── Dockerfile                  # Custom image with pandas/numpy/requests
│   └── n8n-task-runners.json       # JS + Python runner configuration
├── docling/
│   ├── download-models.sh          # Pre-download VLM models
│   ├── hf-cache/                   # HuggingFace model cache
│   ├── models/                     # Docling pipeline artifacts
│   └── documents/                  # Shared document I/O
└── systemd/
    ├── n8n-check-updates.service   # Update check oneshot service
    └── n8n-check-updates.timer     # Daily timer trigger
```

## Key Features

### Podman-Native

Built specifically for Podman instead of Docker. Uses direct bind mounts, systemd timers for update checks, and SELinux-compatible volume labels (`:Z`).

### External Task Runners

Code nodes execute in a separate container with sandboxed JavaScript and Python runtimes. Python runner includes pandas, numpy, and requests. Tasks are limited to 600-second timeouts with a max concurrency of 15.

### AI Document Processing

Docling Serve provides a REST API for converting documents (PDF, DOCX, images) to structured formats. Pre-bundled models handle layout analysis, table extraction, OCR, and formula recognition. Optional VLM models (SmolDocling-256M, Granite-Docling-258M) provide semantic document understanding on CPU.

### Redis Chat Memory

Redis stores AI agent conversation history across workflow runs using n8n's Redis Chat Memory LangChain node. Configure in the n8n UI with host `n8n-redis`, port `6379`, and the password from `.env`.

### Automated Update Checks

A systemd timer runs daily to check for new container image versions. Updates are never applied automatically -- results are logged to the systemd journal for manual review.

## Common Operations

```bash
# Check service status
podman-compose ps

# View real-time resource usage
podman stats --no-stream

# Follow logs
podman-compose logs -f n8n

# Update a service
podman-compose pull n8n
podman-compose up -d n8n

# Rebuild runners after changing dependencies
podman-compose build n8n-runners
podman-compose up -d n8n-runners

# Check for available image updates
sudo systemctl start n8n-check-updates.service
journalctl -u n8n-check-updates.service --since today
```

## Documentation

See [PRODUCTION-DEPLOYMENT-GUIDE.md](PRODUCTION-DEPLOYMENT-GUIDE.md) for detailed documentation on:

- Podman compatibility notes
- Redis configuration and monitoring
- Docling Serve usage from n8n workflows (sync and async)
- Service startup order
- Update workflow
- Monitoring and CloudWatch alarms
- Troubleshooting

## Security Notes

- `.env` contains secrets and is set to `chmod 600` -- do not commit it to version control
- The n8n encryption key (`N8N_ENCRYPTION_KEY`) must never be changed after first launch -- it encrypts all stored credentials
- PostgreSQL and Redis are only accessible on the internal container network (no external ports)
- Node.js task runners use `--disallow-code-generation-from-strings` and `--disable-proto=delete` security flags
- HTTPS is enforced with secure cookies

## License

This project is provided as-is for deploying n8n on AWS infrastructure.
